<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>响应式</title>
</head>

<body>
  <script>
    /* bucket WeakMap 桶
        key Map 对象
          key Set 对象的每个key都有对应的fn
    */
    // 
    function cleanup(effectFn) {
      effectFn.deps.forEach(deps=> {
        deps.delete(effectFn)
      })

      effectFn.deps.length = 0
    }

    let activeFn
    function effect(fn) {
      const effectFn = ()=> {
        cleanup(effectFn)
        activeFn = effectFn
        fn()
      } 
      effectFn.deps = []
      effectFn()
    }
    function track(target, key) {
      if (!activeFn) return

      let depsMap = bucket.get(target)
      if (!depsMap) {
        bucket.set(target, depsMap = new Map())
      }
      let deps = depsMap.get(key)
      if (!deps) {
        depsMap.set(key, deps = new Set())
      }
      deps.add(activeFn)

      activeFn.deps.push(deps)
    }
    function trigger(target, key) {
      const depsMap = bucket.get(target)
      if (!depsMap) return

      const deps = depsMap.get(key)
      if (!deps) return
      deps.forEach(fn => fn())
    }
    const bucket = new WeakMap()
    const data = {
      text: 'Hello World',
      a: 1,
    }
    const obj = new Proxy(data, {
      get(target, key) {
        track(target ,key)
        return target[key]
      },
      set(target, key, value) {
        target[key] = value
        trigger(target, key)
        return true
      },
    })

    effect(() => {
      document.body.innerText = obj.text
      console.log('obj.text', obj.text);
    })
    effect(() => {
      console.log('obj.a', obj.a)
    })
    window.obj = obj






  </script>
</body>

</html>